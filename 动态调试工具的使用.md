在安卓逆向中是有很多调试工具可供使用的，比如IDA,JEB PRO,Android killer,Andrioid stuidio,对于涉及到nvative层的代码的调试需要使用IDA PRO来进行动态调试，还可以使用Frida，xposed或者是edxposed来hook进行动态调试。下面我将就这些工具的简单使用进行一步说明。
<a name="ALzWu"></a>
# 1. JEB PRO动态调试
下面我以一个简单的APK来进行说明，该APK文件科欧从下面的github网址上进行下载使用。<br />对于动态调试是需要在apk中Manifest.xml文件中需要加上android:debuggable="true"一项的，如果使用JEB PR打开该apk文件的时候发现没有该项，那么需要借助于Androidkiller工具加上该项并进行重新编译签名生成一个新的apk再来进行调试。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662886890732-f6fc4916-4af1-4ebb-9dbe-4f60252c5829.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=578&id=u53ee9c34&margin=%5Bobject%20Object%5D&name=image.png&originHeight=867&originWidth=1718&originalType=binary&ratio=1&rotation=0&showTitle=false&size=135793&status=done&style=none&taskId=udcb8d505-4f58-47af-9c4d-c79fef3fd9c&title=&width=1145.3333333333333)<br />对于APK文件JEB PRO自动反编译后的文件是smali格式的，可以使用TAB键将其转换为对应的源代码模式值得注意的是JEB PRO并不支持全局搜索的功能，而JADX-GUI是支持此功能的。<br />对于APK的动态调试是提供两种方式的，其中一种是以debug模式启动该APK，另外一种模式就是以正常的方式来启动我们需要调试的APK。
<a name="d7Xk3"></a>
## 1.1 正常模式启动APK
在该模式下就是正常的运行该APK，需要保证手机将该APK顺利启动完成即可。<br />然后选择调试器->开始调试就会出现下面的画面。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662887436669-707f8e88-a0f4-4b7c-b98d-9b9057f63073.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=585&id=u0d843613&margin=%5Bobject%20Object%5D&name=image.png&originHeight=877&originWidth=1547&originalType=binary&ratio=1&rotation=0&showTitle=false&size=68838&status=done&style=none&taskId=uade92a88-7a78-4569-aeaf-14bc9364bbc&title=&width=1031.3333333333333)<br />如果发现在设备一栏没有找到我们连接的设备，那么可以尝试先将该设备与PC断开，然后再连接，接着就点击Refresh Machine List按钮。查看是否可以成功识别出我们的测试机，如果还是不行的话，建议打开任务管理器找到adb.exe进程并杀死然后重新进行上述操作。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662887646444-8efe4c43-1d29-4851-b909-3ccfe58b7115.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=395&id=uad1a803b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=593&originWidth=1800&originalType=binary&ratio=1&rotation=0&showTitle=false&size=86942&status=done&style=none&taskId=u6fda0ccb-37df-4e4b-b4dc-58c3581cdda&title=&width=1200)<br />如果还是不行的话建议更改adb的环境变量或者是检测是否是测试机出现了问题。<br />在测试机上如果找到了我们需要调试的进程，那么下一步将将该进程attched到我们的JEB PRO上面。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662887803143-460d51c3-6f57-4743-b604-026cecc9c11e.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=433&id=ufd697e88&margin=%5Bobject%20Object%5D&name=image.png&originHeight=649&originWidth=983&originalType=binary&ratio=1&rotation=0&showTitle=false&size=40445&status=done&style=none&taskId=ucad01f09-701e-4123-aa87-caf84421111&title=&width=655.3333333333334)<br />一旦attch成功就会出现下面的画面。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662888072266-d3dd7a03-fa74-4933-96b7-1dee5deddff2.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=520&id=u73d897c6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=780&originWidth=1588&originalType=binary&ratio=1&rotation=0&showTitle=false&size=102102&status=done&style=none&taskId=u457d8af7-99f7-43cc-b375-4f1f2efa993&title=&width=1058.6666666666667)<br />在attch进程之前注意要关闭注入Android stdio之类的调试软件。<br />下面就是进行下断点运行了，只支持在smali指令上下断点，可以在源码处找到下端的位置然后使用TAB键就会自动转换到相应的smali指令处，下短线的快捷键是CTRL+B。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662888255184-9085b4ae-c3a6-4561-97e9-fb46b78db112.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=385&id=uc737ccd4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=577&originWidth=1561&originalType=binary&ratio=1&rotation=0&showTitle=false&size=74389&status=done&style=none&taskId=u07bb7e60-0f03-4e50-a2f3-25e494b4663&title=&width=1040.6666666666667)<br />接着点击操作APK这要看你下断点的位置，如果你下断点在后面的位置那么需要你操作APK让其可以运行到你下断点的位置，然后点击运行即可运行到你下断点的位置。否则会到等待你输入的那一步。如果顺利的话及优惠呈现下面的画面，可以使用快捷键F7,F8来进行单步调试的操作了。然后直接点击继续运行那么会它运行到下一个断点的位置。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662888958168-d1da3fe6-c008-4591-abe4-7c8e4364be3e.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=625&id=u0e5f48b7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=938&originWidth=1758&originalType=binary&ratio=1&rotation=0&showTitle=false&size=137507&status=done&style=none&taskId=udc5902a5-6a37-4843-8634-6d8d31f2187&title=&width=1172)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662889662779-69478c5f-a8f4-4f63-8346-6d9b5c20c74d.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=303&id=u299e86f5&margin=%5Bobject%20Object%5D&name=image.png&originHeight=455&originWidth=1035&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39866&status=done&style=none&taskId=u367d001a-8367-4d18-9329-1f17252f0a1&title=&width=690)<br />注意如果查看的变量是string类型，那么就要把int转换为string类型就可以查看到我们输入的字符串的内容了，如果没有在变量列表里面看到我们需要查看的变量那么需要逐个打印试出来。
<a name="iVfUx"></a>
## 1.2 以debug模式启动APK
只是APK启动的方式有差别，调试的过程都是类似的。<br />启动Apk的命令是：
> adb shell am start -D -n com.example.test.ctf02/com.example.test.ctf02.MainActivity

![897bb82b0ad0e88d6d61528b2132a10.jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/21766399/1662890222633-48f5525e-203e-4163-9c28-3e7384cf8fa9.jpeg#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=3072&id=ubbfdbd62&margin=%5Bobject%20Object%5D&name=897bb82b0ad0e88d6d61528b2132a10.jpg&originHeight=4608&originWidth=3456&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2781669&status=done&style=none&taskId=udbd1917f-6cc9-4d08-b6ac-908b3fd170f&title=&width=2304)<br />当attch成功后就会进入到apk的主界面如下：<br />![91e789e7de1b927c0346f1afae3fc77.jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/21766399/1662890308614-ebcbf0ee-87ea-423d-9893-db24a2d32e1a.jpeg#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=1109&id=u65f81710&margin=%5Bobject%20Object%5D&name=91e789e7de1b927c0346f1afae3fc77.jpg&originHeight=1664&originWidth=768&originalType=binary&ratio=1&rotation=0&showTitle=false&size=256071&status=done&style=none&taskId=u0ae54ffd-f0ab-4434-917b-1e71e90d673&title=&width=512)<br />就可以进行上述的调试了。
<a name="Znoaw"></a>
# 2.  Android studio调试apk
首先启动Android stdio，记住需要安装smalidea 插件我是从网上海下载该插件然后在Android studio进行本地安装的，选择File->Profile or debug apk来打开我们需要调试的apk文件，接着将测试机与PC使用数据线连接完成后，点击下方按钮（需要注意的是android studio连接的模拟器一定是我们班的测试机而不是AS创建的虚拟机），<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662891295241-2678073b-0a81-4930-92f0-4869109b9758.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=920&id=uefd4f67b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1380&originWidth=1542&originalType=binary&ratio=1&rotation=0&showTitle=false&size=211763&status=done&style=none&taskId=u3441390d-8ce3-42b2-9222-a34ce550ec4&title=&width=1028)<br />当AS与我们的测试机上的apk进程attached完成后也是需要在相应的位置下一个断点来进行单步调试或者打印变量内容的。![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662891197448-75f37c7c-cfed-4b04-84ec-8cec671aefc1.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=931&id=u455f17a2&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1396&originWidth=1210&originalType=binary&ratio=1&rotation=0&showTitle=false&size=178526&status=done&style=none&taskId=ue5b63aad-9700-4ae6-87a7-060062ed12b&title=&width=806.6666666666666)
<a name="WpTZy"></a>
# 3. Androidkiller调试APK
[链接](https://hjw45611.github.io/blog/2019/06/13/AndroidKiller%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/)<br />Androidkiller的主要优势在于是支持修改smali代码。点击该按钮会将文件锁定为只读模式，再次点击就可以解锁变成了编辑模式。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662902725996-0e52c037-21ab-423c-8fd8-4b37395aae67.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=630&id=uea514603&margin=%5Bobject%20Object%5D&name=image.png&originHeight=945&originWidth=1820&originalType=binary&ratio=1&rotation=0&showTitle=false&size=338068&status=done&style=none&taskId=u94877d2b-37b7-442e-8237-6cf018f5ab2&title=&width=1213.3333333333333)<br />修改完成记得要进行重新编译一下才可以正确使用。
<a name="qurCY"></a>
# 4. IDA动态调试so库
对于现在的apk会把核心代码都放到native层上面，那么就需要使用IDA PRO来进行动态调试了。<br />首先还是需要使用Android killer工具修改Manifest.xml配置文件，加上**android:debuggable="true"**  配置，这样的话该apk就可以被调试了。<br />然后找到IDA PRO的安装目录，选择需要调试的程序所的运行平台的server文件。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662903429843-50d0c839-12d3-4006-a02c-447d9705223c.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=451&id=ue2384bf0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=676&originWidth=1442&originalType=binary&ratio=1&rotation=0&showTitle=false&size=102357&status=done&style=none&taskId=u99838b47-9a84-4598-a0d2-be9e4614aa8&title=&width=961.3333333333334)<br />接着是查看手机的cpu架构。使用的命令是
> getprop ro.product.cpu.abi

![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662903548752-ca1e695e-7eee-406e-8672-2c5c6d199a87.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=142&id=u4afdab55&margin=%5Bobject%20Object%5D&name=image.png&originHeight=213&originWidth=1417&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16376&status=done&style=none&taskId=u8780b1a9-a168-4230-9fb0-0f0aa6fba00&title=&width=944.6666666666666)<br />然后选择相应的server文件将其福追到手机的/data/local/tmp目录上并进行提权。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662903678539-8ad0a411-91ff-40b8-aa4d-48750f94e1ef.png#clientId=ufb0bea72-15fa-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=505&id=u160c482b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=757&originWidth=2158&originalType=binary&ratio=1&rotation=0&showTitle=false&size=100364&status=done&style=none&taskId=u6d01be8c-b544-4351-9ce8-ddad85b3a7b&title=&width=1438.6666666666667)<br />接着是执行该server文件，并且可以指定启动时候的端口
```bash
./android_server64 -p 22222
```
然后为了方便使用可以进行端口转发，
```bash
adb forward tcp:11111 tcp:22222    //表示将本地的11111端口转发到远程手机上的22222端口
```
经过上述的端口转发后，监听本地的11111端口就可以监听到安卓测试机上22222端口运行的进程即android_server64运行的信息了。<br />和前面讲的一样是支持两种方式启动的，即普通方式启动APK的调试与DEBUG模式启动APK的调试，如果是调试代码的逻辑那么就选择普通的方式启动apk的调试，如果是调试在启动之前的代码逻辑那么就需要使用以DEBUG方式启动来进行相应的调试了。
<a name="ALZtg"></a>
## 4.1 普通模式调试
可以使用下面输入命令的方式来启动也可以手动点击来进行启动。
```bash
adb shell am start -n com.example.test.ctf03/com.example.test.ctf03.MainActivity
```
然后打开IDA来加载出我们需要调试的apk中的so库文件。<br />接着进行IDA调试的配置，选择调试器Remote ARM linux/Android debugger调试。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662904452697-83aa303b-de9f-481b-9ea3-88fbc8f056ba.png#clientId=u4184004a-b489-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=485&id=ufd811b55&margin=%5Bobject%20Object%5D&name=image.png&originHeight=728&originWidth=1052&originalType=binary&ratio=1&rotation=0&showTitle=false&size=89381&status=done&style=none&taskId=ufb72be07-f410-45c2-af4c-544b3d11050&title=&width=701.3333333333334)<br />记住在debvugger options要勾选下面几项。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662904487832-a06149ac-f049-42c3-9aae-771629681599.png#clientId=u4184004a-b489-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=543&id=u302dca3b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=814&originWidth=989&originalType=binary&ratio=1&rotation=0&showTitle=false&size=97397&status=done&style=none&taskId=u850eff31-6edd-48b3-8fb1-a22338df7cd&title=&width=659.3333333333334)<br />配置process options。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662904545815-c200ac8f-8225-4e4f-a342-9cb8b9d8dbed.png#clientId=u4184004a-b489-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=469&id=u3d9ec2ec&margin=%5Bobject%20Object%5D&name=image.png&originHeight=704&originWidth=1250&originalType=binary&ratio=1&rotation=0&showTitle=false&size=98488&status=done&style=none&taskId=u7771c008-72eb-4577-9cb5-a7898a509f0&title=&width=833.3333333333334)<br />注意如果出现不兼容的版本记得将安卓端的server换成32位的也就是android_server。(建议切到adb shell使用su身份来运行)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662906029389-af8fcf8b-ce73-4ad0-a0c3-508d0e53bff3.png#clientId=uc67efca6-8832-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=627&id=u440378ec&margin=%5Bobject%20Object%5D&name=image.png&originHeight=941&originWidth=1340&originalType=binary&ratio=1&rotation=0&showTitle=false&size=145125&status=done&style=none&taskId=u3d77d1e6-1807-4be8-8997-719648e71c2&title=&width=893.3333333333334)<br />这表示在手机中找到和本地加载相同的 so 文件，选择 same：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662909019240-52cf1c7e-4355-4fd1-a3cd-09d52029c311.png#clientId=uc67efca6-8832-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=476&id=uc5f07717&margin=%5Bobject%20Object%5D&name=image.png&originHeight=714&originWidth=2473&originalType=binary&ratio=1&rotation=0&showTitle=false&size=79373&status=done&style=none&taskId=u0619f576-cae7-45eb-a115-1bdc8fbfd80&title=&width=1648.6666666666667)<br />接着在module中搜索libnative.so模块，该模块是我们需要调试的模块，然后定位到我们需要打断点处的函数位置并打断点来进行下一步的调试。（android_server与IDA PRO都使用的是32位）<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662909204331-a9c26dae-fa3a-4cdb-98b3-86b578e02c01.png#clientId=uc67efca6-8832-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=250&id=ue16fe325&margin=%5Bobject%20Object%5D&name=image.png&originHeight=375&originWidth=1219&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38323&status=done&style=none&taskId=uaab713bd-4873-47b3-bcbe-7fecac0197f&title=&width=812.6666666666666)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662909400487-53a0e157-be1d-4363-a8ac-8069de410a8a.png#clientId=uc67efca6-8832-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=289&id=u56a13d72&margin=%5Bobject%20Object%5D&name=image.png&originHeight=434&originWidth=1197&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31664&status=done&style=none&taskId=u8ed61fbe-34c8-4e82-81cc-59894d2a14a&title=&width=798)<br />接着就是单步调试即可。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662909510045-cb474319-c701-4b6c-b652-abc2bc09efe1.png#clientId=uc67efca6-8832-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=750&id=u57f02bc0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1125&originWidth=2236&originalType=binary&ratio=1&rotation=0&showTitle=false&size=251939&status=done&style=none&taskId=uf7d21328-75a1-4958-8a4e-2f5578fbb4a&title=&width=1490.6666666666667)
<a name="icwbC"></a>
## 4.2 Debug模式调试
首先以debug模式启动apk
> adb shell am start -D -n com.example.test.ctf03/com.example.test.ctf03.MainActivity

接着发现在Android device monitor工具中在调试的陈故乡前面多了一个红色的虫子（Android studio  的 Android\Sdk\tools 目录下monitor.exe）<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662909782106-fea8b201-c606-4f93-84f0-583044f109b1.png#clientId=uc67efca6-8832-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=494&id=u7f026f6c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=741&originWidth=2026&originalType=binary&ratio=1&rotation=0&showTitle=false&size=57198&status=done&style=none&taskId=u539df2f1-8f83-48de-b345-51ab54d3f5b&title=&width=1350.6666666666667)<br />接着打开IDA加载so库文件（同上）

然后执行jdb命令如下
> jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8601

![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662910191607-ed1000b9-54b2-4756-bf18-5ac811fccd98.png#clientId=uc67efca6-8832-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=638&id=u830e3e3c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=957&originWidth=2022&originalType=binary&ratio=1&rotation=0&showTitle=false&size=91290&status=done&style=none&taskId=u9f0d9b24-dfc4-437a-96a7-431a722c4eb&title=&width=1348)<br />执行完成之后，**红色的虫子变为绿色的虫子**，接着就可以开始调试了，接着按F9(可以多按几次)就会出现下面的内容。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662910277598-a76219eb-65ad-4d93-8e52-e7428ce26414.png#clientId=uc67efca6-8832-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=701&id=Jynwg&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1052&originWidth=3127&originalType=binary&ratio=1&rotation=0&showTitle=false&size=150193&status=done&style=none&taskId=ua1ad95c6-e844-498d-a9c8-9fadecad689&title=&width=2084.6666666666665)<br />也可以找到我们需要调试的模块了。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662910405833-4be7a92e-177a-4a28-ab42-69fde487aa42.png#clientId=uc67efca6-8832-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=297&id=u9805424d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=445&originWidth=1512&originalType=binary&ratio=1&rotation=0&showTitle=false&size=50963&status=done&style=none&taskId=uc244f502-6c25-43ef-9acd-7c04961bdbc&title=&width=1008)<br />接着就是下断点进行响应的单步调试了。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/21766399/1662911153317-d5f4bc00-3110-4329-a73c-d9d8aeb6890a.png#clientId=uc67efca6-8832-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=709&id=u7f53968c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1064&originWidth=3284&originalType=binary&ratio=1&rotation=0&showTitle=false&size=324788&status=done&style=none&taskId=u62b202d7-1b30-4fab-a0c9-0c84ae51307&title=&width=2189.3333333333335)

